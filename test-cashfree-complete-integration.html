<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cashfree Payment Integration - Complete Test</title>
    
    <!-- Cashfree SDK V4 -->
    <script src="https://sdk.cashfree.com/js/v4/cashfree.js"></script>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .test-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .test-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .warning { color: #f59e0b; }
        .info { color: #3b82f6; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">
                üè¶ Cashfree Payment Gateway - Complete Integration Test
            </h1>
            <p class="text-gray-600 mb-4">
                Test your Cashfree Web (Redirect) integration with comprehensive scenarios and debugging tools.
            </p>
            
            <!-- Configuration Status -->
            <div id="configStatus" class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="flex items-center">
                    <div class="spinner mr-3"></div>
                    <span class="text-blue-800">Loading payment configuration...</span>
                </div>
            </div>
        </div>

        <!-- Test Controls -->
        <div class="grid md:grid-cols-2 gap-6 mb-6">
            <!-- Payment Form -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">üí≥ Payment Test Form</h2>
                
                <form id="paymentForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Amount (INR)</label>
                        <input type="number" id="amount" value="100.50" min="1" max="99999" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Customer Phone</label>
                        <input type="tel" id="customerPhone" value="9999999999" pattern="[6-9][0-9]{9}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Customer Email</label>
                        <input type="email" id="customerEmail" value="test@example.com"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Customer Name</label>
                        <input type="text" id="customerName" value="Test Customer"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Order Note</label>
                        <input type="text" id="orderNote" value="Test payment from integration test"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <button type="submit" id="payButton" 
                            class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        <span id="payButtonText">üöÄ Create Payment Order</span>
                    </button>
                </form>
            </div>

            <!-- Quick Test Scenarios -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">‚ö° Quick Test Scenarios</h2>
                
                <div class="space-y-3">
                    <button onclick="runQuickTest('small')" 
                            class="test-card w-full bg-green-50 border border-green-200 rounded-lg p-3 text-left hover:bg-green-100">
                        <div class="font-medium text-green-800">üí∞ Small Amount Test</div>
                        <div class="text-sm text-green-600">‚Çπ1.00 payment test</div>
                    </button>
                    
                    <button onclick="runQuickTest('large')" 
                            class="test-card w-full bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-left hover:bg-yellow-100">
                        <div class="font-medium text-yellow-800">üíé Large Amount Test</div>
                        <div class="text-sm text-yellow-600">‚Çπ9999.00 payment test</div>
                    </button>
                    
                    <button onclick="runQuickTest('invalid')" 
                            class="test-card w-full bg-red-50 border border-red-200 rounded-lg p-3 text-left hover:bg-red-100">
                        <div class="font-medium text-red-800">‚ùå Invalid Data Test</div>
                        <div class="text-sm text-red-600">Test error handling</div>
                    </button>
                    
                    <button onclick="runQuickTest('realtime')" 
                            class="test-card w-full bg-purple-50 border border-purple-200 rounded-lg p-3 text-left hover:bg-purple-100">
                        <div class="font-medium text-purple-800">üîÑ Real-time Test</div>
                        <div class="text-sm text-purple-600">Live payment flow</div>
                    </button>
                </div>
            </div>
        </div>

        <!-- Debug Tools -->
        <div class="grid md:grid-cols-3 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">üîß Debug Tools</h3>
                <div class="space-y-2">
                    <button onclick="testApiConnection()" 
                            class="w-full bg-blue-500 text-white py-2 px-3 rounded text-sm hover:bg-blue-600">
                        Test API Connection
                    </button>
                    <button onclick="checkEnvironment()" 
                            class="w-full bg-green-500 text-white py-2 px-3 rounded text-sm hover:bg-green-600">
                        Check Environment
                    </button>
                    <button onclick="simulateWebhook()" 
                            class="w-full bg-purple-500 text-white py-2 px-3 rounded text-sm hover:bg-purple-600">
                        Simulate Webhook
                    </button>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">üìä Test Results</h3>
                <div id="testStats" class="text-sm space-y-1">
                    <div>Orders Created: <span id="ordersCreated" class="font-medium">0</span></div>
                    <div>Successful: <span id="successfulOrders" class="font-medium text-green-600">0</span></div>
                    <div>Failed: <span id="failedOrders" class="font-medium text-red-600">0</span></div>
                    <div>Success Rate: <span id="successRate" class="font-medium">0%</span></div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">‚è±Ô∏è Performance</h3>
                <div id="performanceStats" class="text-sm space-y-1">
                    <div>Avg Response: <span id="avgResponse" class="font-medium">-</span></div>
                    <div>Fastest: <span id="fastestResponse" class="font-medium text-green-600">-</span></div>
                    <div>Slowest: <span id="slowestResponse" class="font-medium text-red-600">-</span></div>
                    <div>Total Requests: <span id="totalRequests" class="font-medium">0</span></div>
                </div>
            </div>
        </div>

        <!-- Results Panel -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800">üìù Test Results & Logs</h2>
                <button onclick="clearLogs()" 
                        class="bg-gray-500 text-white py-1 px-3 rounded text-sm hover:bg-gray-600">
                    Clear Logs
                </button>
            </div>
            
            <div id="results" class="bg-gray-50 rounded-lg p-4 min-h-[300px] max-h-[400px] overflow-y-auto font-mono text-sm">
                <div class="text-gray-500">Ready for testing...</div>
            </div>
        </div>

        <!-- Cashfree Test Cards Info -->
        <div class="bg-white rounded-lg shadow-md p-6 mt-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">üí≥ Cashfree Test Cards (Sandbox)</h2>
            <div class="grid md:grid-cols-2 gap-4">
                <div>
                    <h3 class="font-medium text-gray-700 mb-2">‚úÖ Successful Payment</h3>
                    <div class="bg-green-50 border border-green-200 rounded p-3 text-sm">
                        <div><strong>Card Number:</strong> 4111 1111 1111 1111</div>
                        <div><strong>Expiry:</strong> Any future date</div>
                        <div><strong>CVV:</strong> Any 3 digits</div>
                    </div>
                </div>
                <div>
                    <h3 class="font-medium text-gray-700 mb-2">‚ùå Failed Payment</h3>
                    <div class="bg-red-50 border border-red-200 rounded p-3 text-sm">
                        <div><strong>Card Number:</strong> 4012 0010 3714 1112</div>
                        <div><strong>Expiry:</strong> Any future date</div>
                        <div><strong>CVV:</strong> Any 3 digits</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let paymentConfig = null;
        let testStats = {
            ordersCreated: 0,
            successful: 0,
            failed: 0,
            responses: []
        };

        // Initialize the test page
        async function init() {
            await loadPaymentConfig();
            updateTestStats();
        }

        // Load payment configuration
        async function loadPaymentConfig() {
            try {
                logMessage('üì° Loading payment configuration...', 'info');
                
                const response = await fetch('/api/payment-enhanced/config');
                paymentConfig = await response.json();
                
                if (paymentConfig.success) {
                    updateConfigStatus(true);
                    logMessage(`‚úÖ Payment gateway configured: ${paymentConfig.environment} mode`, 'success');
                } else {
                    updateConfigStatus(false);
                    logMessage('‚ùå Payment gateway not configured', 'error');
                }
            } catch (error) {
                updateConfigStatus(false);
                logMessage(`‚ùå Failed to load configuration: ${error.message}`, 'error');
            }
        }

        // Update configuration status display
        function updateConfigStatus(isConfigured) {
            const statusDiv = document.getElementById('configStatus');
            
            if (isConfigured) {
                statusDiv.innerHTML = `
                    <div class="flex items-center">
                        <div class="text-green-600 mr-3">‚úÖ</div>
                        <div>
                            <div class="text-green-800 font-medium">Payment Gateway Active</div>
                            <div class="text-green-600 text-sm">
                                Environment: ${paymentConfig.environment} | 
                                Configured: ${paymentConfig.isConfigured} | 
                                Enabled: ${paymentConfig.enabled}
                            </div>
                        </div>
                    </div>
                `;
                statusDiv.className = 'bg-green-50 border border-green-200 rounded-lg p-4';
            } else {
                statusDiv.innerHTML = `
                    <div class="flex items-center">
                        <div class="text-red-600 mr-3">‚ùå</div>
                        <div>
                            <div class="text-red-800 font-medium">Payment Gateway Not Available</div>
                            <div class="text-red-600 text-sm">Check your configuration and try again</div>
                        </div>
                    </div>
                `;
                statusDiv.className = 'bg-red-50 border border-red-200 rounded-lg p-4';
            }
        }

        // Log messages to results panel
        function logMessage(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            const typeEmoji = {
                'success': '‚úÖ',
                'error': '‚ùå',
                'warning': '‚ö†Ô∏è',
                'info': '‚ÑπÔ∏è'
            };
            
            const logEntry = document.createElement('div');
            logEntry.className = `mb-2 ${type}`;
            logEntry.innerHTML = `<span class="text-gray-500">${timestamp}</span> ${typeEmoji[type]} ${message}`;
            
            resultsDiv.appendChild(logEntry);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        // Clear logs
        function clearLogs() {
            document.getElementById('results').innerHTML = '<div class="text-gray-500">Logs cleared...</div>';
        }

        // Create payment order
        async function createPaymentOrder(orderData) {
            const startTime = Date.now();
            
            try {
                logMessage(`üöÄ Creating payment order for ‚Çπ${orderData.amount}...`, 'info');
                
                const response = await fetch('/api/payment-enhanced/create-order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });

                const responseTime = Date.now() - startTime;
                testStats.responses.push(responseTime);

                const result = await response.json();
                
                testStats.ordersCreated++;
                
                if (result.success) {
                    testStats.successful++;
                    logMessage(`‚úÖ Order created successfully: ${result.data.order_id}`, 'success');
                    logMessage(`üìä Payment session: ${result.data.payment_session_id ? 'Created' : 'Missing'}`, 'info');
                    logMessage(`‚ö° Response time: ${responseTime}ms`, 'info');
                    
                    return result;
                } else {
                    testStats.failed++;
                    logMessage(`‚ùå Order creation failed: ${result.error.message}`, 'error');
                    logMessage(`üîç Error code: ${result.error.code}`, 'error');
                    return result;
                }
            } catch (error) {
                testStats.failed++;
                logMessage(`‚ùå Network error: ${error.message}`, 'error');
                return { success: false, error: { message: error.message } };
            } finally {
                updateTestStats();
            }
        }

        // Process payment with Cashfree
        async function processPayment(orderResult) {
            if (!orderResult.success) {
                logMessage('‚ùå Cannot process payment - order creation failed', 'error');
                return;
            }

            const { payment_session_id, order_id, environment } = orderResult.data;

            try {
                // Try SDK method first
                if (window.Cashfree) {
                    logMessage('üîÑ Initializing Cashfree SDK checkout...', 'info');
                    
                    const cashfree = window.Cashfree({
                        mode: environment === 'production' ? 'production' : 'sandbox'
                    });

                    await cashfree.checkout({
                        paymentSessionId: payment_session_id,
                        redirectTarget: "_self"
                    });

                    logMessage('‚úÖ Redirected to Cashfree payment page', 'success');
                } else {
                    // Fallback to server redirect
                    logMessage('‚ö†Ô∏è SDK not available, using server redirect...', 'warning');
                    window.location.href = `/api/payment-enhanced/checkout/${order_id}`;
                }
            } catch (error) {
                logMessage(`‚ùå Payment processing failed: ${error.message}`, 'error');
                // Fallback to server redirect
                logMessage('üîÑ Falling back to server redirect...', 'info');
                window.location.href = `/api/payment-enhanced/checkout/${order_id}`;
            }
        }

        // Handle payment form submission
        document.getElementById('paymentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const button = document.getElementById('payButton');
            const buttonText = document.getElementById('payButtonText');
            
            // Disable button during processing
            button.disabled = true;
            buttonText.innerHTML = '<div class="spinner"></div> Creating Order...';
            
            try {
                // Collect form data
                const orderData = {
                    amount: parseFloat(document.getElementById('amount').value),
                    customer: {
                        customer_phone: document.getElementById('customerPhone').value,
                        customer_email: document.getElementById('customerEmail').value,
                        customer_name: document.getElementById('customerName').value
                    },
                    orderNote: document.getElementById('orderNote').value,
                    order_currency: 'INR'
                };

                // Create order
                const orderResult = await createPaymentOrder(orderData);
                
                if (orderResult.success) {
                    // Process payment
                    await processPayment(orderResult);
                }
            } finally {
                // Re-enable button
                button.disabled = false;
                buttonText.innerHTML = 'üöÄ Create Payment Order';
            }
        });

        // Quick test functions
        async function runQuickTest(testType) {
            logMessage(`üéØ Running quick test: ${testType}`, 'info');
            
            let orderData;
            
            switch (testType) {
                case 'small':
                    orderData = {
                        amount: 1.00,
                        customer: {
                            customer_phone: '9999999999',
                            customer_email: 'small@test.com',
                            customer_name: 'Small Amount Test'
                        },
                        orderNote: 'Small amount test payment'
                    };
                    break;
                    
                case 'large':
                    orderData = {
                        amount: 9999.00,
                        customer: {
                            customer_phone: '9999999999',
                            customer_email: 'large@test.com',
                            customer_name: 'Large Amount Test'
                        },
                        orderNote: 'Large amount test payment'
                    };
                    break;
                    
                case 'invalid':
                    orderData = {
                        amount: -100,
                        customer: {
                            customer_phone: '123',
                            customer_email: 'invalid-email',
                            customer_name: ''
                        },
                        orderNote: 'Invalid data test'
                    };
                    break;
                    
                case 'realtime':
                    orderData = {
                        amount: Math.floor(Math.random() * 1000) + 100,
                        customer: {
                            customer_phone: '9999999999',
                            customer_email: `test${Date.now()}@example.com`,
                            customer_name: 'Real-time Test User'
                        },
                        orderNote: 'Real-time generated test order'
                    };
                    break;
            }
            
            const result = await createPaymentOrder(orderData);
            
            if (result.success && testType !== 'invalid') {
                await processPayment(result);
            }
        }

        // Debug functions
        async function testApiConnection() {
            logMessage('üîó Testing API connection...', 'info');
            
            try {
                const response = await fetch('/api/payment-enhanced/debug/api-connection');
                const result = await response.json();
                
                if (result.success) {
                    logMessage('‚úÖ API connection test successful', 'success');
                } else {
                    logMessage(`‚ùå API connection test failed: ${result.error.message}`, 'error');
                }
                
                logMessage(`üìÑ Full response: ${JSON.stringify(result, null, 2)}`, 'info');
            } catch (error) {
                logMessage(`‚ùå Connection test error: ${error.message}`, 'error');
            }
        }

        async function checkEnvironment() {
            logMessage('üåç Checking environment configuration...', 'info');
            
            try {
                const response = await fetch('/api/payment-enhanced/debug/environment');
                const result = await response.json();
                
                logMessage('üìä Environment Information:', 'info');
                logMessage(`Environment: ${result.environment}`, 'info');
                logMessage(`Client URL: ${result.urls.client_auto}`, 'info');
                logMessage(`Server URL: ${result.urls.server_auto}`, 'info');
                logMessage(`Cashfree Environment: ${result.cashfree.environment}`, 'info');
                logMessage(`Cashfree Enabled: ${result.cashfree.enabled}`, 'info');
            } catch (error) {
                logMessage(`‚ùå Environment check error: ${error.message}`, 'error');
            }
        }

        async function simulateWebhook() {
            logMessage('üîî Simulating webhook...', 'info');
            
            const webhookData = {
                order_id: `test_webhook_${Date.now()}`,
                cf_order_id: Math.random().toString(36).substring(7),
                order_status: 'PAID',
                payment_status: 'SUCCESS',
                payment_amount: 100.00,
                payment_currency: 'INR',
                payment_timestamp: new Date().toISOString()
            };
            
            try {
                const response = await fetch('/api/payment-enhanced/webhook', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(webhookData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    logMessage('‚úÖ Webhook simulation successful', 'success');
                } else {
                    logMessage('‚ùå Webhook simulation failed', 'error');
                }
            } catch (error) {
                logMessage(`‚ùå Webhook simulation error: ${error.message}`, 'error');
            }
        }

        // Update test statistics
        function updateTestStats() {
            document.getElementById('ordersCreated').textContent = testStats.ordersCreated;
            document.getElementById('successfulOrders').textContent = testStats.successful;
            document.getElementById('failedOrders').textContent = testStats.failed;
            
            const successRate = testStats.ordersCreated > 0 
                ? Math.round((testStats.successful / testStats.ordersCreated) * 100)
                : 0;
            document.getElementById('successRate').textContent = `${successRate}%`;
            
            // Performance stats
            if (testStats.responses.length > 0) {
                const avg = Math.round(testStats.responses.reduce((a, b) => a + b, 0) / testStats.responses.length);
                const fastest = Math.min(...testStats.responses);
                const slowest = Math.max(...testStats.responses);
                
                document.getElementById('avgResponse').textContent = `${avg}ms`;
                document.getElementById('fastestResponse').textContent = `${fastest}ms`;
                document.getElementById('slowestResponse').textContent = `${slowest}ms`;
            }
            
            document.getElementById('totalRequests').textContent = testStats.responses.length;
        }

        // Initialize when page loads
        window.addEventListener('load', init);
    </script>
</body>
</html>
